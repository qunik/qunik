// ---- –ò–ì–†–ê ----

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// –ó–∞–º–µ–Ω–∏—Ç–µ –ø—É—Ç–∏ –Ω–∞ —Å–≤–æ–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
const dinoImg = new Image();
dinoImg.src = 'images/dino.png';

const cactusImg = new Image();
cactusImg.src = 'images/cactus.png';

// –†–∞–∑–º–µ—Ä—ã –º–æ–¥–µ–ª–µ–π (–∫–∞–∫ —Ç—ã —Ö–æ—Ç–µ–ª)
const dinoWidth = 80;
const dinoHeight = 80;
const cactusWidth = 40;
const cactusHeight = 60;

let gameRunning = false;
let dinoY = canvas.height - dinoHeight - 20;
let dinoX = 50;

let velocityY = 0;
const gravity = 1.2;
let isJumping = false;

let cactuses = [];
let speed = 6;
let score = 0;
let lastTimestamp = 0;

// –¢–∞–π–º–µ—Ä –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–∞–∫—Ç—É—Å–∞
let nextCactusTime = 0;

// –ö–Ω–æ–ø–∫–∞ –∏–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞ (—Å–æ–∑–¥–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
const replayBtn = document.createElement('button');
replayBtn.textContent = 'üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞';
replayBtn.style.position = 'absolute';
replayBtn.style.top = '50%';
replayBtn.style.left = '50%';
replayBtn.style.transform = 'translate(-50%, -50%)';
replayBtn.style.padding = '12px 24px';
replayBtn.style.fontSize = '24px';
replayBtn.style.borderRadius = '12px';
replayBtn.style.border = 'none';
replayBtn.style.cursor = 'pointer';
replayBtn.style.display = 'none';
replayBtn.style.zIndex = '1000';
gameContainer.appendChild(replayBtn);

replayBtn.addEventListener('click', () => {
  resetGame();
  replayBtn.style.display = 'none';
  gameRunning = true;
  requestAnimationFrame(gameLoop);
});

// –ü—Ä—ã–∂–æ–∫
function jump() {
  if (!isJumping) {
    velocityY = -18;
    isJumping = true;
  }
}
document.addEventListener('keydown', e => {
  if (e.code === 'Space' || e.code === 'ArrowUp') {
    e.preventDefault();
    jump();
  }
});

function resetGame() {
  cactuses = [];
  score = 0;
  speed = 6;
  velocityY = 0;
  isJumping = false;
  dinoY = canvas.height - dinoHeight - 20;
  scoreDiv.textContent = score;
  lastTimestamp = 0;
  nextCactusTime = 1000; // –ø–µ—Ä–≤—ã–π –∫–∞–∫—Ç—É—Å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
  replayBtn.style.display = 'none';
}

function gameLoop(timestamp) {
  if (!lastTimestamp) lastTimestamp = timestamp;
  const deltaTime = timestamp - lastTimestamp;
  lastTimestamp = timestamp;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  score += deltaTime * 0.01;
  scoreDiv.textContent = Math.floor(score);

  // –ü—Ä—ã–∂–æ–∫ –∏–≥—Ä–æ–∫–∞
  velocityY += gravity;
  dinoY += velocityY;
  if (dinoY > canvas.height - dinoHeight - 20) {
    dinoY = canvas.height - dinoHeight - 20;
    isJumping = false;
    velocityY = 0;
  }
  ctx.drawImage(dinoImg, dinoX, dinoY, dinoWidth, dinoHeight);

  // –¢–∞–π–º–µ—Ä –¥–ª—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞–∫—Ç—É—Å–æ–≤
  nextCactusTime -= deltaTime;
  if (nextCactusTime <= 0) {
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–∞–∫—Ç—É—Å —Å–ø—Ä–∞–≤–∞
    cactuses.push({
      x: canvas.width,
      y: canvas.height - cactusHeight - 20,
      width: cactusWidth,
      height: cactusHeight
    });
    // –°–ª–µ–¥—É—é—â–∏–π –∫–∞–∫—Ç—É—Å –ø–æ—è–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ —Å–ª—É—á–∞–π–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª 1 - 3 —Å–µ–∫—É–Ω–¥—ã
    nextCactusTime = 1000 + Math.random() * 2000;
  }

  // –î–≤–∏–∂–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–∫—Ç—É—Å–æ–≤
  for (let i = 0; i < cactuses.length; i++) {
    let c = cactuses[i];
    c.x -= speed;
    ctx.drawImage(cactusImg, c.x, c.y, c.width, c.height);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
    if (
      dinoX < c.x + c.width &&
      dinoX + dinoWidth > c.x &&
      dinoY < c.y + c.height &&
      dinoY + dinoHeight > c.y
    ) {
      gameRunning = false;
      replayBtn.style.display = 'block';
      alert('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í–∞—à —Å—á–µ—Ç: ' + Math.floor(score));
      return;
    }
  }

  // –£–¥–∞–ª—è–µ–º –∫–∞–∫—Ç—É—Å—ã, –≤—ã—à–µ–¥—à–∏–µ –∑–∞ —ç–∫—Ä–∞–Ω —Å–ª–µ–≤–∞
  cactuses = cactuses.filter(c => c.x + c.width > 0);

  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º (—Å–ª–æ–∂–Ω–æ—Å—Ç—å)
  speed += 0.0005;

  if (gameRunning) {
    requestAnimationFrame(gameLoop);
  }
}
